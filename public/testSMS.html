<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TalentLix — Test SMS OTp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    input[type="text"] { min-width: 260px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 700; }
    .primary { background: linear-gradient(90deg, #27E3DA, #F7B84E); color: #fff; }
    .secondary { background: #f1f3f5; color: #333; border: 1px solid #ddd; }
    .muted { color: #6b7280; font-size: 14px; }
    .ok { color: #0a7a4b; }
    .err { color: #b00020; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h2>TalentLix — Test invio/verifica SMS OTP</h2>

  <div class="row">
    <input id="phone" type="text" placeholder="+39XXXXXXXXXX (E.164)" />
    <button id="send" class="primary">Send code</button>
    <span id="sendMsg" class="muted"></span>
  </div>

  <div class="row">
    <input id="otp" type="text" placeholder="Enter 6‑digit code" maxlength="6" />
    <button id="verify" class="secondary">Verify code</button>
    <span id="verifyMsg" class="muted"></span>
  </div>

  <div id="sessionBox" class="muted"></div>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // === CONFIG (già compilata con i tuoi dati) ===
    const SUPABASE_URL = "https://evmwxyvnaumpjubkrxxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bXd4eXZuYXVtcGp1YmtyeHh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMTE1ODIsImV4cCI6MjA2OTY4NzU4Mn0.ufa8qeLawJPiN647XvC-j6e9St5v-6kbqVa61O-6wPI";

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // --- INVIO OTP ---
    el('send').addEventListener('click', async () => {
      const phone = el('phone').value.trim().replace(/\s+/g, '');
      el('sendMsg').className = 'muted';
      el('sendMsg').textContent = '';

      if (!phone || !phone.startsWith('+')) {
        el('sendMsg').className = 'err';
        el('sendMsg').textContent = 'Inserisci il numero in formato internazionale, es. +393401234567';
        return;
      }

      el('send').disabled = true;
      el('send').textContent = 'Sending…';

      // Invia OTP via Supabase Auth (usa Twilio configurato nel progetto)
      const { data, error } = await client.auth.signInWithOtp({
        phone,
        options: {
          // per i test va bene creare l’utente se non esiste
          shouldCreateUser: true,
        }
      });

      if (error) {
        el('sendMsg').className = 'err';
        el('sendMsg').textContent = `Errore invio: ${error.message}`;
        el('send').disabled = false;
        el('send').textContent = 'Send code';
        return;
      }

      el('sendMsg').className = 'ok';
      el('sendMsg').textContent = 'OTP inviato! Controlla l’SMS. (TTL come impostato in Supabase)';
      // piccolo cooldown per evitare doppio invio
      await sleep(30000);
      el('send').disabled = false;
      el('send').textContent = 'Send code';
    });

    // --- VERIFICA OTP ---
    el('verify').addEventListener('click', async () => {
      const phone = el('phone').value.trim().replace(/\s+/g, '');
      const token = el('otp').value.trim();
      el('verifyMsg').className = 'muted';
      el('verifyMsg').textContent = '';

      if (!phone || !phone.startsWith('+')) {
        el('verifyMsg').className = 'err';
        el('verifyMsg').textContent = 'Numero non valido';
        return;
      }
      if (token.length !== 6) {
        el('verifyMsg').className = 'err';
        el('verifyMsg').textContent = 'Il codice deve avere 6 cifre';
        return;
      }

      el('verify').disabled = true;
      el('verify').textContent = 'Verifying…';

      const { data, error } = await client.auth.verifyOtp({
        phone,
        token,
        type: 'sms' // verifica il codice inviato con signInWithOtp
      });

      if (error) {
        el('verifyMsg').className = 'err';
        el('verifyMsg').textContent = `Verifica fallita: ${error.message}`;
        el('verify').disabled = false;
        el('verify').textContent = 'Verify code';
        return;
      }

      el('verifyMsg').className = 'ok';
      el('verifyMsg').textContent = 'Verificato ✔';

      // Mostra qualche info di sessione (opzionale, utile per capire che è andato a buon fine)
      const session = (await client.auth.getSession()).data.session;
      el('sessionBox').innerHTML = session
        ? `<div>Sessione attiva • user: <span class="mono">${session.user.id}</span></div>`
        : `<div class="muted">Nessuna sessione (ok per test OTP).</div>`;

      el('verify').disabled = false;
      el('verify').textContent = 'Verify code';
    });
  </script>
</body>
</html>
