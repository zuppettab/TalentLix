<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione telefoni Supabase</title>
</head>
<body>
  <h2>Utenti con telefono</h2>
  <div id="users">Caricamento...</div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const PROJECT_URL = "https://evmwxyvnaumpjubkrxxx.supabase.co";
    const SERVICE_ROLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bXd4eXZuYXVtcGp1YmtyeHh4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDExMTU4MiwiZXhwIjoyMDY5Njg3NTgyfQ.xq0G7F8RATkg8iBaKIQaGjXwn2yi5VLJkNDkIgmJtaA";

    const supabaseAdmin = createClient(PROJECT_URL, SERVICE_ROLE_KEY);

    async function loadUsers() {
      const container = document.getElementById("users");
      container.innerHTML = "Caricamento utenti...";

      const { data, error } = await supabaseAdmin.auth.admin.listUsers();

      if (error) {
        container.innerText = "Errore: " + error.message;
        return;
      }

      if (!data || !data.users || data.users.length === 0) {
        container.innerText = "Nessun utente trovato in Supabase.";
        return;
      }

      const withPhones = data.users.filter(u => u.phone);
      if (withPhones.length === 0) {
        container.innerText = "Utenti trovati, ma nessuno ha un telefono associato.";
        return;
      }

      container.innerHTML = "";
      withPhones.forEach(u => {
        const div = document.createElement("div");
        div.style.marginBottom = "10px";
        div.innerHTML = `
          <b>${u.email || "senza email"}</b><br>
          Telefono: ${u.phone}<br>
          <button>Rimuovi telefono</button>
          <hr>
        `;
        div.querySelector("button").onclick = async () => {
          const { error: updError } = await supabaseAdmin.auth.admin.updateUserById(u.id, {
            phone: null
          });
          if (updError) {
            alert("Errore: " + updError.message);
          } else {
            alert("Telefono rimosso per utente " + (u.email || u.id));
            loadUsers(); // ricarica lista
          }
        };
        container.appendChild(div);
      });
    }

    loadUsers();
  </script>
</body>
</html>
